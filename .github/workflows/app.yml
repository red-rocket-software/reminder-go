on: [push, pull_request]
name: CI

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      db:
        image: postgres:latest
        env:
          POSTGRES_USER: root
          POSTGRES_PASSWORD: secret
          POSTGRES_DB: test_reminder
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v3

      - name: Set up Go 1.19
        uses: actions/setup-go@v3
        with:
          go-version: ^1.19

      - name: Install golang-migrate
        run: |
          curl -L https://github.com/golang-migrate/migrate/releases/download/v4.14.1/migrate.linux-amd64.tar.gz | tar xvz
          sudo mv migrate.linux-amd64 /usr/bin/migrate
          which migrate

      - name: Run migrations
        run: make migrateup_test

      - name: run test
        run: make test

  lint:
    name: lint
    runs-on: ubuntu-latest
    steps:
        - name: Setup Go
          uses: actions/setup-go@v3.0.0
          with:
            go-version: 1.19

        - uses: actions/checkout@v2

        - name: golangci-lint
          uses: golangci/golangci-lint-action@v3.1.0
          with:
            # Optional: version of golangci-lint to use in form of v1.2 or v1.2.3 or `latest` to use the latest version
            version: v1.45.2
  
  build:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/stage'
    needs: [test, lint]
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      - name: Build Reminder image
        run: |
          docker build \
            --file dockers/Dockerfile-reminder \
            -t eu.gcr.io/coa-project-5c923/coa-reminder:latest \
            .
            docker image ls

      - name: Build Worker image
        run: |
          docker build \
            --file dockers/Dockerfile-worker \
            -t eu.gcr.io/coa-project-5c923/coa-worker:latest \
            .
          docker image ls

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@main
        with:
          version: 'latest'
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          project_id: coa-project-5c923

      - name: Login to Google Container Registry
        run: |
          gcloud auth configure-docker europe-central2-docker.pkg.dev

      - name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v1'
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Push Docker images
        run: |
          echo ${{ secrets.GCP_SA_KEY }} > auth.json
          gcloud auth activate-service-account --key-file auth.json
          docker push eu.gcr.io/coa-project-5c923/coa-reminder:latest
          docker push eu.gcr.io/coa-project-5c923/coa-worker:latest
  
  manual-approval:
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/stage'
    steps:
      - uses: trstringer/manual-approval@v1
        with:
          secret: ${{ github.TOKEN }}
          approvers: PavelDonchenko,vitalis-virtus,penkova
          minimum-approvals: 1
          issue-title: "Deploying Reminder and Worker to cluster"
          issue-body: "Please approve or deny the deployment of Reminder and Worker images"

  deploy:
    runs-on: ubuntu-latest
    needs: [manual-approval]
    if: github.ref == 'refs/heads/stage'
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@main
        with:
          version: 'latest'
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          project_id: coa-project-5c923

      - name: Configure Docker and Kubectl
        run: |
          gcloud --quiet components update
          gcloud --quiet components install kubectl
          gcloud auth configure-docker --quiet

      - name: Install Helm
        run: |
          curl https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash

      - name: Deploy to GKE
        run: |
          git clone https://github.com/red-rocket-software/coa-infrastructure.git
          cd coa-infrastructure
          git checkout dev
          cd Helm
          helm upgrade --install staging-reminder-release reminder-chart \
            --set image=eu.gcr.io/coa-project-5c923/coa-reminder \
            --set tag=latest
          helm upgrade --install staging-worker-release worker-chart \
            --set image=eu.gcr.io/coa-project-5c923/coa-worker \
            --set tag=latest

# test ci run